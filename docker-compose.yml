version: '3.8'

services:
  backend-wearwhat:
    build: .
    container_name: backend-wearwhat
    ports:
      - "8000:8000"
    environment:
      # Database
      - DATABASE_URL=postgresql://postgres:postgres@postgres-wearwhat:5432/wearwhat
      # MinIO
      - MINIO_ENDPOINT=minio-wearwhat:9000
      - MINIO_PUBLIC_URL=localhost:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin123
      - MINIO_BUCKET_NAME=uploads
      - MINIO_SECURE=false
      # Qdrant
      - QDRANT_HOST=qdrant-wearwhat
      - QDRANT_PORT=6333
      # Clerk Auth
      - CLERK_JWKS_URL=${CLERK_JWKS_URL}
      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENWEATHERMAP_API_KEY=${OPENWEATHERMAP_API_KEY}
    depends_on:
      - postgres-wearwhat
      - minio-wearwhat
      - qdrant-wearwhat
    restart: unless-stopped

  postgres-wearwhat:
    image: postgres:17-alpine
    container_name: postgres-wearwhat
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=wearwhat
    volumes:
      - postgres_wearwhat_data:/var/lib/postgresql/data
      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    restart: unless-stopped

  minio-wearwhat:
    image: minio/minio
    container_name: minio-wearwhat
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
    volumes:
      - minio_wearwhat_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped

  qdrant-wearwhat:
    image: qdrant/qdrant
    container_name: qdrant-wearwhat
    volumes:
      - qdrant_wearwhat_data:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"
    restart: unless-stopped

volumes:
  postgres_wearwhat_data:
  minio_wearwhat_data:
  qdrant_wearwhat_data:
